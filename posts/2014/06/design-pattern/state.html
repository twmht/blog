<!DOCTYPE html>
<html>
<head>
    <link rel="SHORTCUT ICON" href="http://twmht.github.io/blog/favicon.ico">
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="author" content="twmht" />
    <meta name="robots" content="index, follow"/>

    <meta property="og:title" content="State Pattern"/>
    <meta property="og:url" content="http://twmht.github.io/blog/posts/2014/06/design-pattern/state.html"/>
    <meta property="og:site_name" content="技術筆記"/>
    <meta property="og:type" content="article"/>

    <link rel="canonical" href="http://twmht.github.io/blog/posts/2014/06/design-pattern/state.html" />

    <title>State Pattern | 技術筆記</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="stylesheet" type="text/css" href="//netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css" />
    <link rel="stylesheet" type="text/css" href="//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/css/bootstrap-combined.min.css" />

    <link rel="stylesheet" type="text/css" href="http://twmht.github.io/blog/theme/css/main.css" />
    <link href="http://twmht.github.io/blog/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="技術筆記 Atom Feed" />

    <script type="text/javascript">var switchTo5x=true;</script>
    <script type="text/javascript" src="http://w.sharethis.com/button/buttons.js"></script>
    <script type="text/javascript">
        stLight.options({
            publisher: "",
            doNotHash: false,
            doNotCopy: false,
            hashAddressBar: false
        });
    </script>
</head>

<body id="index">
    <div class="row-fluid">
        <div class="span10 offset1">
            <header id="banner" >
                <h1>
                    <a href="http://twmht.github.io/blog/">技術筆記 </a>
                </h1>
                <nav class="navbar">
                    <div class="navbar-inner">
                        <ul class="nav">
                            <li ><a href="http://twmht.github.io/blog/category/acm.html">ACM</a></li>
                            <li ><a href="http://twmht.github.io/blog/category/android.html">android</a></li>
                            <li ><a href="http://twmht.github.io/blog/category/cc.html">C/C++</a></li>
                            <li class="active"><a href="http://twmht.github.io/blog/category/design-pattern.html">Design Pattern</a></li>
                            <li ><a href="http://twmht.github.io/blog/category/linux.html">linux</a></li>
                            <li ><a href="http://twmht.github.io/blog/category/multithread.html">Multithread</a></li>
                            <li ><a href="http://twmht.github.io/blog/category/others.html">Others</a></li>
                            <li ><a href="http://twmht.github.io/blog/category/python.html">Python</a></li>
                        </ul>

<script>
  (function() {
    var cx = '011100128719699788018:4mb0t5kqbse';
    var gcse = document.createElement('script'); gcse.type = 'text/javascript'; gcse.async = true;
    gcse.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') +
        '//www.google.com/cse/cse.js?cx=' + cx;
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(gcse, s);
  })();
</script>
<div id="google-custom-search" class="nav">
    <gcse:search></gcse:search>
</div>
                    </div>
                </nav>
            </header><!-- /#banner -->
        </div>
    </div>

    <div class="row-fluid">
        <div class="span10 offset1">
            <div class="row-fluid">
<div class="span10 offset1">
  <section>
    <article>
      <header>
        <h1 class="entry-title">
          <a href="http://twmht.github.io/blog/posts/2014/06/design-pattern/state.html" rel="bookmark"
             title="Permalink to State Pattern">State Pattern</a></h1>
      </header>
      <div class="entry-content">
<footer class="post-info">
    <address class="vcard author">
        by <a class="url fn" href="http://twmht.github.io/blog/author/twmht.html">twmht</a>
    </address>

    in <a href="http://twmht.github.io/blog/category/design-pattern.html">Design Pattern</a>

    on 2014-06-29




    
</footer><!-- /.post-info -->

        <h3>用的時間點</h3>
<p>用類別來表示 "狀態" 。</p>
<h3>如何設計</h3>
<p>以類別來表示狀態之後，只要切換類別就能表現 "狀態變化"，而且在必須新增其它狀態時，也很清楚該編寫哪個部份。</p>
<h3>程式範例</h3>
<p>假設現在有一個會隨著時間改變警備狀態的金庫保全系統：</p>
<ul>
<li>有一個金庫</li>
<li>金庫有跟保全中心連線</li>
<li>金庫有警鈴和一般通話用的電話</li>
<li>金庫有時鐘，監視目前的時間</li>
<li>白天是9:00-16:59，晚間為17:00-23:59以及0:00-8:59</li>
<li>只有白天才能使用金庫</li>
<li>在白天使用金庫時，保全中心會保留使用紀錄</li>
<li>若晚間使用金庫時，保全中心會接到發生異常現象的通知</li>
<li>警鈴是24小時都可以使用</li>
<li>一旦使用警鈴，保全中心會接收到警鈴通知</li>
<li>一般通話用的電話是24小時都可以使用(但晚間只有答錄機服務)</li>
<li>在白天使用電話時，就會呼叫保全中心</li>
<li>若晚間使用電話時，則會呼叫保全中心的答錄機</li>
</ul>
<script src="https://gist.github.com/twmht/a04e437a923e01314421.js"></script>

<h4>State 參與者</h4>
<p>State 表示狀態。規定不同狀態下做不同處理的介面。這個介面等於是一個不同狀態所做處理的所有方法的集合。例如 State 介面。</p>
<h4>ConcreteState 參與者</h4>
<p>ConcreteState 是表示具體的不同狀態，具體實作在 State 所規定的介面。例如 DayState 以及 NightState 類別。</p>
<h4>Context 參與者</h4>
<p>Context 具有表示現在狀態的 ConcreteState，而且還規定 State Pattern 的利用者所需要的介面。例如 Context 介面以及 SafeFrame 類別。
Context 介面負責規定介面的部份，SafeFrame 類別則負責具有 ConcreteState 參與者的部份。</p>
<h3>優點</h3>
<h4>Divide and Conquer</h4>
<p>State Pattern 是以<strong>類別</strong>來表示<strong>狀態</strong>。利用不同的類別分別表示各種具體狀態的動作就是在分割問題。當在寫某一個 ConcreteState 時，可以讓自己以為沒有其他類別，彷彿獨立開來一樣。</p>
<p>如果不用這個 Pattern 的話，使用金庫時所呼叫的方法就得根據現在的狀態進行處理。狀態種類愈多，條件判斷就愈多;況且所有發生時所呼叫的所有方法都要寫同樣的條件判斷處理。</p>
<p>因為 State Pattern 是用類別來表示系統<strong>狀態</strong>，所以才能細細分割一個龐大複雜的程式。</p>
<h4>有該狀態才會有的處理</h4>
<p>SafeFrame 類別的 setClock 方法是被 Main 類別呼叫出來。Main 類別呼叫 setClock 方法說<em>請設定時間</em>。在 setClock 方法中，這個處理委讓給 state，也就是說，設定時間被當作一個<strong>有現在的狀態才會有的處理</strong>。</p>
<p>不只是 doClock 方法，State 介面所宣告的方法都是<strong>有該狀態才會有的處理</strong>，其實就是<strong>因狀態而異的處理</strong>。</p>
<p>可以以下面兩點為基礎設計:</p>
<ul>
<li>宣告成抽象方法，作為介面</li>
<li>實作成具體方法，作為不同的類別</li>
</ul>
<h4>不會有自我矛盾</h4>
<p>如果不用這個 Pattern，改以多個變數之值的集合來表示系統狀態，這時候變數值之間不能有自我矛盾或不一致的情形。</p>
<p>State Pattern 中，表示現在狀態的變數只有一個(SafeFrame 類別中的 state 變數)。因此不會有自我矛盾的情形。</p>
<h4>新增狀態很容易</h4>
<p>新增狀態非常簡單。不過，如果想在已經完成的 State Pattern 中新增一個<strong>有狀態才會有的處理</strong>就沒那麼容易。因為這個新增的動作代表了要在 State 參與者的介面新增其他方法的意思，而且所有的 ConcreteState 都要新增這個處理。</p>
<p>雖然這個動作有點困難，但卻不用擔心會不小心忘記新增，因為編譯器會自動報錯。比起不用State Pattern，而用大量的 if 條件敘述要好用的多。</p>
<h3>多樣的物件個體</h3>
<p>SafeFrame 類別中出現了下面兩種敘述：</p>
<ul>
<li>在 SafeFrame 建構子內: buttonUse.addActionListener(this);</li>
<li>在 actionPerformed 方法內: state.doUse(this)</li>
</ul>
<p>兩個 this 都是 SafeFrame 類別的物件個體。因為只會產生一個 SafeFrame 的物個體，因此這兩個 this 為同值。</p>
<p>在傳遞給 addActionListener 方法時，這個物件個體被視為<strong>實作 ActionListener 介面之類別的物件個體</strong>。因為 addActionListener 方法的引數是 ActionListener 型態。在 addActionListener 方法中，引數的使用範圍是在<strong>ActionListener 介面所規定的方法的範圍之內</strong>。傳遞過來做為引數的是不是 SafeFrame 的物件個體根本不重要。</p>
<p>而在傳遞給 doUse 方法的時候，同樣的物件個體卻被視為<strong>實作 Context 介面之類別的物件個體</strong>。因為 doUse 方法的引數是 Context 型態。在 doUse 方法中，<strong>引數的使用範圍是在 Context 介面所規定方法的範圍之內</strong>。</p>
<h3>問題</h3>
<h4>1. 理論上，Context 應該要設成抽象類別而非介面，而 state 欄位應該要規類到 Context 類別才符合 Pattern 的主旨，但是程式範例卻把 Context 設成介面，而 state 欄位則是放在 SafeFrame 類別，為什麼?</h4>
<p>由於 Java 是單一繼承，因此如果以類別表示 Context 的話，就不能再把已經是 Frame 的子類別之 SafeFrame 類別設為 Context 類別的子類別。</p>
<p>如果要做的話，應該要另外作一個 Context 類別的子類別，將其物件個體儲存在 SafeFrame 的欄位，用委讓的方式去做。</p>
<h4>2. 如果想把範例程式中的白天改成 8:00-20.59，而晚間改成 21:00~23:59 和 0:00~7:59。該如何修改?</h4>
<p>需要修改 DayState 和 NightState 類別的 doClock 方法。</p>
<p>如果一開始先在 SafeFrame 類別建立 isDay 方法和 isNight 方法，預先準備好檢查目前時間是白天還是夜晚的方式，就能把具體的時間範圍放到 SafeFrame 類別之內。這樣之後就只要修改 SafeFrame 類別即可。</p>
<h4>3. 請加入 <strong>午餐時間</strong>(12:00~12:59) 這個新狀態。若午餐時間使用金庫，則保全中心會接到發生異常狀態的通知;若使用警鈴，則保全中心會接到警鈴通知，若使用電話，則會呼叫保全中心的答錄機。</h4>
<p>新增一個 NoonState 類別。</p>
<div class="highlight"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">NoonState</span> <span class="kd">implements</span> <span class="n">State</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="n">NoonState</span> <span class="n">singleton</span> <span class="o">=</span> <span class="k">new</span> <span class="n">NoonState</span><span class="o">();</span>
    <span class="kd">private</span> <span class="nf">NoonState</span><span class="o">()</span> <span class="o">{</span>                                <span class="c1">// 建構子為private</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="n">State</span> <span class="nf">getInstance</span><span class="o">()</span> <span class="o">{</span>                 <span class="c1">// 取得唯一的個體</span>
        <span class="k">return</span> <span class="n">singleton</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">doClock</span><span class="o">(</span><span class="n">Context</span> <span class="n">context</span><span class="o">,</span> <span class="kt">int</span> <span class="n">hour</span><span class="o">)</span> <span class="o">{</span>    <span class="c1">// 設定時間</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">hour</span> <span class="o">&lt;</span> <span class="mi">9</span> <span class="o">||</span> <span class="mi">17</span> <span class="o">&lt;=</span> <span class="n">hour</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">context</span><span class="o">.</span><span class="na">changeState</span><span class="o">(</span><span class="n">NightState</span><span class="o">.</span><span class="na">getInstance</span><span class="o">());</span>
        <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="mi">9</span> <span class="o">&lt;=</span> <span class="n">hour</span> <span class="o">&amp;&amp;</span> <span class="n">hour</span> <span class="o">&lt;</span> <span class="mi">12</span> <span class="o">||</span> <span class="mi">13</span> <span class="o">&lt;=</span> <span class="n">hour</span> <span class="o">&amp;&amp;</span> <span class="n">hour</span> <span class="o">&lt;</span> <span class="mi">17</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">context</span><span class="o">.</span><span class="na">changeState</span><span class="o">(</span><span class="n">DayState</span><span class="o">.</span><span class="na">getInstance</span><span class="o">());</span>
        <span class="o">}</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">doUse</span><span class="o">(</span><span class="n">Context</span> <span class="n">context</span><span class="o">)</span> <span class="o">{</span>                <span class="c1">// 使用金庫</span>
        <span class="n">context</span><span class="o">.</span><span class="na">callSecurityCenter</span><span class="o">(</span><span class="s">&quot;異常：午餐時間使用金庫！&quot;</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">doAlarm</span><span class="o">(</span><span class="n">Context</span> <span class="n">context</span><span class="o">)</span> <span class="o">{</span>              <span class="c1">// 警鈴</span>
        <span class="n">context</span><span class="o">.</span><span class="na">callSecurityCenter</span><span class="o">(</span><span class="s">&quot;警鈴(午餐時間)&quot;</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">doPhone</span><span class="o">(</span><span class="n">Context</span> <span class="n">context</span><span class="o">)</span> <span class="o">{</span>              <span class="c1">// 一般通話</span>
        <span class="n">context</span><span class="o">.</span><span class="na">recordLog</span><span class="o">(</span><span class="s">&quot;午餐時間的通話錄音&quot;</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">toString</span><span class="o">()</span> <span class="o">{</span>                          <span class="c1">// 輸出字串</span>
        <span class="k">return</span> <span class="s">&quot;[午餐時間]&quot;</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>


<p>DayState 的 doClock 方法都要修改。</p>
<div class="highlight"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">DayState</span> <span class="kd">implements</span> <span class="n">State</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="n">DayState</span> <span class="n">singleton</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DayState</span><span class="o">();</span>
    <span class="kd">private</span> <span class="nf">DayState</span><span class="o">()</span> <span class="o">{</span>                                <span class="c1">// 建構子為private</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="n">State</span> <span class="nf">getInstance</span><span class="o">()</span> <span class="o">{</span>                 <span class="c1">// 取得唯一的個體</span>
        <span class="k">return</span> <span class="n">singleton</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">doClock</span><span class="o">(</span><span class="n">Context</span> <span class="n">context</span><span class="o">,</span> <span class="kt">int</span> <span class="n">hour</span><span class="o">)</span> <span class="o">{</span>    <span class="c1">// 設定時間</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">hour</span> <span class="o">&lt;</span> <span class="mi">9</span> <span class="o">||</span> <span class="mi">17</span> <span class="o">&lt;=</span> <span class="n">hour</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">context</span><span class="o">.</span><span class="na">changeState</span><span class="o">(</span><span class="n">NightState</span><span class="o">.</span><span class="na">getInstance</span><span class="o">());</span>
        <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="mi">12</span> <span class="o">&lt;=</span> <span class="n">hour</span> <span class="o">&amp;&amp;</span> <span class="n">hour</span> <span class="o">&lt;</span> <span class="mi">13</span><span class="o">)</span> <span class="o">{</span>                   
            <span class="n">context</span><span class="o">.</span><span class="na">changeState</span><span class="o">(</span><span class="n">NoonState</span><span class="o">.</span><span class="na">getInstance</span><span class="o">());</span>       
        <span class="o">}</span>                                                       
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">doUse</span><span class="o">(</span><span class="n">Context</span> <span class="n">context</span><span class="o">)</span> <span class="o">{</span>                <span class="c1">// 使用金庫</span>
        <span class="n">context</span><span class="o">.</span><span class="na">recordLog</span><span class="o">(</span><span class="s">&quot;使用金庫(白天)&quot;</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">doAlarm</span><span class="o">(</span><span class="n">Context</span> <span class="n">context</span><span class="o">)</span> <span class="o">{</span>              <span class="c1">// 警鈴</span>
        <span class="n">context</span><span class="o">.</span><span class="na">callSecurityCenter</span><span class="o">(</span><span class="s">&quot;警鈴(白天)&quot;</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">doPhone</span><span class="o">(</span><span class="n">Context</span> <span class="n">context</span><span class="o">)</span> <span class="o">{</span>              <span class="c1">// 一般通話</span>
        <span class="n">context</span><span class="o">.</span><span class="na">callSecurityCenter</span><span class="o">(</span><span class="s">&quot;一般的通話(白天)&quot;</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">toString</span><span class="o">()</span> <span class="o">{</span>                          <span class="c1">// 輸出字串</span>
        <span class="k">return</span> <span class="s">&quot;[白天]&quot;</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>


<p>NightState 類別的 doClock 方法都要修改。</p>
<div class="highlight"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">NightState</span> <span class="kd">implements</span> <span class="n">State</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="n">NightState</span> <span class="n">singleton</span> <span class="o">=</span> <span class="k">new</span> <span class="n">NightState</span><span class="o">();</span>
    <span class="kd">private</span> <span class="nf">NightState</span><span class="o">()</span> <span class="o">{</span>                              <span class="c1">// 建構子為private</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="n">State</span> <span class="nf">getInstance</span><span class="o">()</span> <span class="o">{</span>                 <span class="c1">// 取得唯一的個體</span>
        <span class="k">return</span> <span class="n">singleton</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">doClock</span><span class="o">(</span><span class="n">Context</span> <span class="n">context</span><span class="o">,</span> <span class="kt">int</span> <span class="n">hour</span><span class="o">)</span> <span class="o">{</span>    <span class="c1">// 設定時間</span>
        <span class="k">if</span> <span class="o">(</span><span class="mi">9</span> <span class="o">&lt;=</span> <span class="n">hour</span> <span class="o">&amp;&amp;</span> <span class="n">hour</span> <span class="o">&lt;</span> <span class="mi">17</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">context</span><span class="o">.</span><span class="na">changeState</span><span class="o">(</span><span class="n">DayState</span><span class="o">.</span><span class="na">getInstance</span><span class="o">());</span>
        <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="mi">12</span> <span class="o">&lt;=</span> <span class="n">hour</span> <span class="o">&amp;&amp;</span> <span class="n">hour</span> <span class="o">&lt;</span> <span class="mi">13</span><span class="o">)</span> <span class="o">{</span>                   
            <span class="n">context</span><span class="o">.</span><span class="na">changeState</span><span class="o">(</span><span class="n">NoonState</span><span class="o">.</span><span class="na">getInstance</span><span class="o">());</span>       
        <span class="o">}</span>                                                       
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">doUse</span><span class="o">(</span><span class="n">Context</span> <span class="n">context</span><span class="o">)</span> <span class="o">{</span>                <span class="c1">// 使用金庫</span>
        <span class="n">context</span><span class="o">.</span><span class="na">callSecurityCenter</span><span class="o">(</span><span class="s">&quot;異常：晚間使用金庫！&quot;</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">doAlarm</span><span class="o">(</span><span class="n">Context</span> <span class="n">context</span><span class="o">)</span> <span class="o">{</span>              <span class="c1">// 警鈴</span>
        <span class="n">context</span><span class="o">.</span><span class="na">callSecurityCenter</span><span class="o">(</span><span class="s">&quot;警鈴(晚間)&quot;</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">doPhone</span><span class="o">(</span><span class="n">Context</span> <span class="n">context</span><span class="o">)</span> <span class="o">{</span>              <span class="c1">// 一般通話</span>
        <span class="n">context</span><span class="o">.</span><span class="na">recordLog</span><span class="o">(</span><span class="s">&quot;晚間的通話錄音&quot;</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">toString</span><span class="o">()</span> <span class="o">{</span>                          <span class="c1">// 輸出字串</span>
        <span class="k">return</span> <span class="s">&quot;[晚間]&quot;</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>


<h4>3. 請加入<strong>緊急</strong>這個新狀態。當按下警鈴時，無論任何時間，狀態立刻切換到緊急狀態。若緊急狀態時使用金庫，則保全中心接到緊急狀況通知;若使用警鈴，則保全中心會接到警鈴通知;若使用電話，則會呼叫保全中心。</h4>
<p>這個規格的問題在於發生異常之後，沒有可以回到原來狀態的方式。</p>
<p>新增一個 UrgentState 類別。</p>
<div class="highlight"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">UrgentState</span> <span class="kd">implements</span> <span class="n">State</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="n">UrgentState</span> <span class="n">singleton</span> <span class="o">=</span> <span class="k">new</span> <span class="n">UrgentState</span><span class="o">();</span>
    <span class="kd">private</span> <span class="nf">UrgentState</span><span class="o">()</span> <span class="o">{</span>                                <span class="c1">// 建構子為private</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="n">State</span> <span class="nf">getInstance</span><span class="o">()</span> <span class="o">{</span>                 <span class="c1">// 取得唯一的個體</span>
        <span class="k">return</span> <span class="n">singleton</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">doClock</span><span class="o">(</span><span class="n">Context</span> <span class="n">context</span><span class="o">,</span> <span class="kt">int</span> <span class="n">hour</span><span class="o">)</span> <span class="o">{</span>    <span class="c1">// 設定時間</span>
        <span class="c1">// 設定時間的部分不做處理</span>
    <span class="o">}</span>                                                                   
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">doUse</span><span class="o">(</span><span class="n">Context</span> <span class="n">context</span><span class="o">)</span> <span class="o">{</span>                <span class="c1">// 使用金庫</span>
        <span class="n">context</span><span class="o">.</span><span class="na">callSecurityCenter</span><span class="o">(</span><span class="s">&quot;異常：異常使用金庫！&quot;</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">doAlarm</span><span class="o">(</span><span class="n">Context</span> <span class="n">context</span><span class="o">)</span> <span class="o">{</span>              <span class="c1">// 警鈴</span>
        <span class="n">context</span><span class="o">.</span><span class="na">callSecurityCenter</span><span class="o">(</span><span class="s">&quot;警鈴(異常)&quot;</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">doPhone</span><span class="o">(</span><span class="n">Context</span> <span class="n">context</span><span class="o">)</span> <span class="o">{</span>              <span class="c1">// 一般通話</span>
        <span class="n">context</span><span class="o">.</span><span class="na">callSecurityCenter</span><span class="o">(</span><span class="s">&quot;一般的通話(異常)&quot;</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">toString</span><span class="o">()</span> <span class="o">{</span>                          <span class="c1">// 輸出字串</span>
        <span class="k">return</span> <span class="s">&quot;[異常]&quot;</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>


<p>修改 DayState 類別的 doAlarm 方法。</p>
<div class="highlight"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">DayState</span> <span class="kd">implements</span> <span class="n">State</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="n">DayState</span> <span class="n">singleton</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DayState</span><span class="o">();</span>
    <span class="kd">private</span> <span class="nf">DayState</span><span class="o">()</span> <span class="o">{</span>                                <span class="c1">// 建構子為private</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="n">State</span> <span class="nf">getInstance</span><span class="o">()</span> <span class="o">{</span>                 <span class="c1">// 取得唯一的個體</span>
        <span class="k">return</span> <span class="n">singleton</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">doClock</span><span class="o">(</span><span class="n">Context</span> <span class="n">context</span><span class="o">,</span> <span class="kt">int</span> <span class="n">hour</span><span class="o">)</span> <span class="o">{</span>    <span class="c1">// 設定時間</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">hour</span> <span class="o">&lt;</span> <span class="mi">9</span> <span class="o">||</span> <span class="mi">17</span> <span class="o">&lt;=</span> <span class="n">hour</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">context</span><span class="o">.</span><span class="na">changeState</span><span class="o">(</span><span class="n">NightState</span><span class="o">.</span><span class="na">getInstance</span><span class="o">());</span>
        <span class="o">}</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">doUse</span><span class="o">(</span><span class="n">Context</span> <span class="n">context</span><span class="o">)</span> <span class="o">{</span>                <span class="c1">// 使用金庫</span>
        <span class="n">context</span><span class="o">.</span><span class="na">recordLog</span><span class="o">(</span><span class="s">&quot;使用金庫(白天)&quot;</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">doAlarm</span><span class="o">(</span><span class="n">Context</span> <span class="n">context</span><span class="o">)</span> <span class="o">{</span>              <span class="c1">// 警鈴</span>
        <span class="n">context</span><span class="o">.</span><span class="na">callSecurityCenter</span><span class="o">(</span><span class="s">&quot;警鈴(白天)&quot;</span><span class="o">);</span>
        <span class="n">context</span><span class="o">.</span><span class="na">changeState</span><span class="o">(</span><span class="n">UrgentState</span><span class="o">.</span><span class="na">getInstance</span><span class="o">());</span> 
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">doPhone</span><span class="o">(</span><span class="n">Context</span> <span class="n">context</span><span class="o">)</span> <span class="o">{</span>              <span class="c1">// 一般通話</span>
        <span class="n">context</span><span class="o">.</span><span class="na">callSecurityCenter</span><span class="o">(</span><span class="s">&quot;一般的通話(白天)&quot;</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">toString</span><span class="o">()</span> <span class="o">{</span>                          <span class="c1">// 輸出字串</span>
        <span class="k">return</span> <span class="s">&quot;[白天]&quot;</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>


<p>修改 NightState 的 doAlarm 方法。</p>
<div class="highlight"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">NightState</span> <span class="kd">implements</span> <span class="n">State</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="n">NightState</span> <span class="n">singleton</span> <span class="o">=</span> <span class="k">new</span> <span class="n">NightState</span><span class="o">();</span>
    <span class="kd">private</span> <span class="nf">NightState</span><span class="o">()</span> <span class="o">{</span>                              <span class="c1">// 建構子為private</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="n">State</span> <span class="nf">getInstance</span><span class="o">()</span> <span class="o">{</span>                 <span class="c1">// 取得唯一的個體</span>
        <span class="k">return</span> <span class="n">singleton</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">doClock</span><span class="o">(</span><span class="n">Context</span> <span class="n">context</span><span class="o">,</span> <span class="kt">int</span> <span class="n">hour</span><span class="o">)</span> <span class="o">{</span>    <span class="c1">// 設定時間</span>
        <span class="k">if</span> <span class="o">(</span><span class="mi">9</span> <span class="o">&lt;=</span> <span class="n">hour</span> <span class="o">&amp;&amp;</span> <span class="n">hour</span> <span class="o">&lt;</span> <span class="mi">17</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">context</span><span class="o">.</span><span class="na">changeState</span><span class="o">(</span><span class="n">DayState</span><span class="o">.</span><span class="na">getInstance</span><span class="o">());</span>
        <span class="o">}</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">doUse</span><span class="o">(</span><span class="n">Context</span> <span class="n">context</span><span class="o">)</span> <span class="o">{</span>                <span class="c1">// 使用金庫</span>
        <span class="n">context</span><span class="o">.</span><span class="na">callSecurityCenter</span><span class="o">(</span><span class="s">&quot;異常：晚間使用金庫！&quot;</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">doAlarm</span><span class="o">(</span><span class="n">Context</span> <span class="n">context</span><span class="o">)</span> <span class="o">{</span>              <span class="c1">// 警鈴</span>
        <span class="n">context</span><span class="o">.</span><span class="na">callSecurityCenter</span><span class="o">(</span><span class="s">&quot;警鈴(晚間)&quot;</span><span class="o">);</span>
        <span class="n">context</span><span class="o">.</span><span class="na">changeState</span><span class="o">(</span><span class="n">UrgentState</span><span class="o">.</span><span class="na">getInstance</span><span class="o">());</span> 
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">doPhone</span><span class="o">(</span><span class="n">Context</span> <span class="n">context</span><span class="o">)</span> <span class="o">{</span>              <span class="c1">// 一般通話</span>
        <span class="n">context</span><span class="o">.</span><span class="na">recordLog</span><span class="o">(</span><span class="s">&quot;晚間的通話錄音&quot;</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">toString</span><span class="o">()</span> <span class="o">{</span>                          <span class="c1">// 輸出字串</span>
        <span class="k">return</span> <span class="s">&quot;[晚間]&quot;</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>

      </div><!-- /.entry-content -->

    </article>
  </section>
</div>
            </div>
        </div>
    </div>

    <footer id="site-footer">
        <div class="row-fluid">
            <div class="span10 offset1">
                <address>
                    <p>
                        This blog is proudly powered by <a href="http://getpelican.com/">Pelican</a>, which takes great advantage of <a href="http://python.org">Python</a>.
                    </p>
                    <p>
                        <a href="http://github.com/jsliang/pelican-fresh/">Fresh</a> is a responsive theme designed by <a href="http://jsliang.com/">jsliang</a> and <a href="https://github.com/jsliang/pelican-fresh/graphs/contributors">contributors</a>.
                        Special thanks to <a href="http://coding.smashingmagazine.com/2009/08/04/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a> and <a href="http://getbootstrap.com/">Twitter Bootstrap</a>.
                    </p>
                </address>
            </div>
        </div>
    </footer>

    <script src="//code.jquery.com/jquery.min.js"></script>
    <script src="//netdna.bootstrapcdn.com/bootstrap/2.3.2/js/bootstrap.min.js"></script>
</body>
</html>