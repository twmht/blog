<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="author" content="twmht" />
    <meta name="robots" content="index, follow"/>

    <meta property="og:title" content="multiprocessing with map"/>
    <meta property="og:url" content="http://twmht.github.io/blog/posts/2014/07/python/multiprocessing_map.html"/>
    <meta property="og:site_name" content="技術筆記"/>
    <meta property="og:type" content="article"/>

    <link rel="canonical" href="http://twmht.github.io/blog/posts/2014/07/python/multiprocessing_map.html" />

    <title>multiprocessing with map | 技術筆記</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="stylesheet" type="text/css" href="//netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css" />
    <link rel="stylesheet" type="text/css" href="//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/css/bootstrap-combined.min.css" />

    <link rel="stylesheet" type="text/css" href="http://twmht.github.io/blog/theme/css/main.css" />
    <link href="http://twmht.github.io/blog/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="技術筆記 Atom Feed" />

    <script type="text/javascript">var switchTo5x=true;</script>
    <script type="text/javascript" src="http://w.sharethis.com/button/buttons.js"></script>
    <script type="text/javascript">
        stLight.options({
            publisher: "",
            doNotHash: false,
            doNotCopy: false,
            hashAddressBar: false
        });
    </script>
</head>

<body id="index">
    <div class="row-fluid">
        <div class="span10 offset1">
            <header id="banner" >
                <h1>
                    <a href="http://twmht.github.io/blog/">技術筆記 </a>
                </h1>
                <nav class="navbar">
                    <div class="navbar-inner">
                        <ul class="nav">
                            <li ><a href="http://twmht.github.io/blog/category/acm.html">ACM</a></li>
                            <li ><a href="http://twmht.github.io/blog/category/android.html">android</a></li>
                            <li ><a href="http://twmht.github.io/blog/category/cc.html">C/C++</a></li>
                            <li ><a href="http://twmht.github.io/blog/category/design-pattern.html">Design Pattern</a></li>
                            <li ><a href="http://twmht.github.io/blog/category/multithread.html">Multithread</a></li>
                            <li ><a href="http://twmht.github.io/blog/category/others.html">Others</a></li>
                            <li class="active"><a href="http://twmht.github.io/blog/category/python.html">Python</a></li>
                        </ul>

<script>
  (function() {
    var cx = '011100128719699788018:4mb0t5kqbse';
    var gcse = document.createElement('script'); gcse.type = 'text/javascript'; gcse.async = true;
    gcse.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') +
        '//www.google.com/cse/cse.js?cx=' + cx;
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(gcse, s);
  })();
</script>
<div id="google-custom-search" class="nav">
    <gcse:search></gcse:search>
</div>
                    </div>
                </nav>
            </header><!-- /#banner -->
        </div>
    </div>

    <div class="row-fluid">
        <div class="span10 offset1">
            <div class="row-fluid">
<div class="span10 offset1">
  <section>
    <article>
      <header>
        <h1 class="entry-title">
          <a href="http://twmht.github.io/blog/posts/2014/07/python/multiprocessing_map.html" rel="bookmark"
             title="Permalink to multiprocessing with map">multiprocessing with map</a></h1>
      </header>
      <div class="entry-content">
<footer class="post-info">
    <address class="vcard author">
        by <a class="url fn" href="http://twmht.github.io/blog/author/twmht.html">twmht</a>
    </address>

    in <a href="http://twmht.github.io/blog/category/python.html">Python</a>

    on 2014-07-14

        |
        tags:         <a href="http://twmht.github.io/blog/tag/python.html">python</a>
        <a href="http://twmht.github.io/blog/tag/thread.html">thread</a>



    
</footer><!-- /.post-info -->

        <p><a href="https://medium.com/building-things-on-the-internet/parallelism-in-one-line-40e9b2b36148">參考</a></p>
<p>一般來說，會利用 Producer/Consumer 來處理 Multithread。</p>
<div class="highlight"><pre><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">Standard Producer/Consumer Threading Pattern</span>
<span class="sd">&#39;&#39;&#39;</span>

<span class="kn">import</span> <span class="nn">time</span> 
<span class="kn">import</span> <span class="nn">threading</span> 
<span class="kn">import</span> <span class="nn">Queue</span>

<span class="k">class</span> <span class="nc">Consumer</span><span class="p">(</span><span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">):</span> 
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">queue</span><span class="p">):</span> 
        <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_queue</span> <span class="o">=</span> <span class="n">queue</span>

    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span> 
            <span class="c"># queue.get() blocks the current thread until </span>
            <span class="c"># an item is retrieved. </span>
            <span class="n">msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_queue</span><span class="o">.</span><span class="n">get</span><span class="p">()</span> 
            <span class="c"># Checks if the current message is </span>
            <span class="c"># the &quot;Poison Pill&quot;</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="n">msg</span> <span class="o">==</span> <span class="s">&#39;quit&#39;</span><span class="p">:</span>
                <span class="c"># if so, exists the loop</span>
                <span class="k">break</span>
            <span class="c"># &quot;Processes&quot; (or in our case, prints) the queue item   </span>
            <span class="k">print</span> <span class="s">&quot;I&#39;m a thread, and I received </span><span class="si">%s</span><span class="s">!!&quot;</span> <span class="o">%</span> <span class="n">msg</span>
        <span class="c"># Always be friendly! </span>
        <span class="k">print</span> <span class="s">&#39;Bye byes!&#39;</span>

<span class="k">def</span> <span class="nf">Producer</span><span class="p">():</span>
    <span class="c"># Queue is used to share items between</span>
    <span class="c"># the threads.</span>
    <span class="n">queue</span> <span class="o">=</span> <span class="n">Queue</span><span class="o">.</span><span class="n">Queue</span><span class="p">()</span>

    <span class="c"># Create an instance of the worker</span>
    <span class="n">worker</span> <span class="o">=</span> <span class="n">Consumer</span><span class="p">(</span><span class="n">queue</span><span class="p">)</span>
    <span class="c"># start calls the internal run() method to </span>
    <span class="c"># kick off the thread</span>
    <span class="n">worker</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

    <span class="c"># variable to keep track of when we started</span>
    <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> 
    <span class="c"># While under 5 seconds.. </span>
    <span class="k">while</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">:</span> 
        <span class="c"># &quot;Produce&quot; a piece of work and stick it in </span>
        <span class="c"># the queue for the Consumer to process</span>
        <span class="n">queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s">&#39;something at </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())</span>
        <span class="c"># Sleep a bit just to avoid an absurd number of messages</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="c"># This the &quot;poison pill&quot; method of killing a thread. </span>
    <span class="n">queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s">&#39;quit&#39;</span><span class="p">)</span>
    <span class="c"># wait for the thread to close down</span>
    <span class="n">worker</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">Producer</span><span class="p">()</span>
</pre></div>


<p>以上的 worker 只有一個。</p>
<p>以下是多個 worker 的例子，需要建立一個 worker pool。</p>
<div class="highlight"><pre><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">A more realistic thread pool example </span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="kn">import</span> <span class="nn">time</span> 
<span class="kn">import</span> <span class="nn">threading</span> 
<span class="kn">import</span> <span class="nn">Queue</span> 
<span class="kn">import</span> <span class="nn">urllib2</span>

<span class="k">class</span> <span class="nc">Consumer</span><span class="p">(</span><span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">):</span> 
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">queue</span><span class="p">):</span> 
        <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_queue</span> <span class="o">=</span> <span class="n">queue</span>

    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span> 
            <span class="n">content</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_queue</span><span class="o">.</span><span class="n">get</span><span class="p">()</span> 
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">content</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="n">content</span> <span class="o">==</span> <span class="s">&#39;quit&#39;</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">urllib2</span><span class="o">.</span><span class="n">urlopen</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
        <span class="k">print</span> <span class="s">&#39;Bye byes!&#39;</span>

<span class="k">def</span> <span class="nf">Producer</span><span class="p">():</span>
    <span class="n">urls</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s">&#39;http://www.python.org&#39;</span><span class="p">,</span> <span class="s">&#39;http://www.yahoo.com&#39;</span>
        <span class="s">&#39;http://www.scala.org&#39;</span><span class="p">,</span> <span class="s">&#39;http://www.google.com&#39;</span>
        <span class="c"># etc.. </span>
    <span class="p">]</span>
    <span class="n">queue</span> <span class="o">=</span> <span class="n">Queue</span><span class="o">.</span><span class="n">Queue</span><span class="p">()</span>
    <span class="n">worker_threads</span> <span class="o">=</span> <span class="n">build_worker_pool</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
    <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

    <span class="c"># Add the urls to process</span>
    <span class="k">for</span> <span class="n">url</span> <span class="ow">in</span> <span class="n">urls</span><span class="p">:</span> 
        <span class="n">queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>  
    <span class="c"># Add the poison pillv</span>
    <span class="k">for</span> <span class="n">worker</span> <span class="ow">in</span> <span class="n">worker_threads</span><span class="p">:</span>
        <span class="n">queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s">&#39;quit&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">worker</span> <span class="ow">in</span> <span class="n">worker_threads</span><span class="p">:</span>
        <span class="n">worker</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>

    <span class="k">print</span> <span class="s">&#39;Done! Time taken: {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">build_worker_pool</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="n">size</span><span class="p">):</span>
    <span class="n">workers</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">size</span><span class="p">):</span>
        <span class="n">worker</span> <span class="o">=</span> <span class="n">Consumer</span><span class="p">(</span><span class="n">queue</span><span class="p">)</span>
        <span class="n">worker</span><span class="o">.</span><span class="n">start</span><span class="p">()</span> 
        <span class="n">workers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">worker</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">workers</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">Producer</span><span class="p">()</span>
</pre></div>


<p>但這不是最好的方法。而又因為 GIL 的限制，不論多少個 thread，只能佔用一個 CPU 的 core。</p>
<p>使用 multiprocessing 加上 map。</p>
<div class="highlight"><pre><span class="kn">import</span> <span class="nn">urllib2</span> 
<span class="kn">from</span> <span class="nn">multiprocessing.dummy</span> <span class="kn">import</span> <span class="n">Pool</span> <span class="k">as</span> <span class="n">ThreadPool</span>

<span class="n">urls</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s">&#39;http://www.python.org&#39;</span><span class="p">,</span> 
    <span class="s">&#39;http://www.python.org/about/&#39;</span><span class="p">,</span>
    <span class="s">&#39;http://www.onlamp.com/pub/a/python/2003/04/17/metaclasses.html&#39;</span><span class="p">,</span>
    <span class="s">&#39;http://www.python.org/doc/&#39;</span><span class="p">,</span>
    <span class="s">&#39;http://www.python.org/download/&#39;</span><span class="p">,</span>
    <span class="s">&#39;http://www.python.org/getit/&#39;</span><span class="p">,</span>
    <span class="s">&#39;http://www.python.org/community/&#39;</span><span class="p">,</span>
    <span class="s">&#39;https://wiki.python.org/moin/&#39;</span><span class="p">,</span>
    <span class="s">&#39;http://planet.python.org/&#39;</span><span class="p">,</span>
    <span class="s">&#39;https://wiki.python.org/moin/LocalUserGroups&#39;</span><span class="p">,</span>
    <span class="s">&#39;http://www.python.org/psf/&#39;</span><span class="p">,</span>
    <span class="s">&#39;http://docs.python.org/devguide/&#39;</span><span class="p">,</span>
    <span class="s">&#39;http://www.python.org/community/awards/&#39;</span>
    <span class="c"># etc.. </span>
    <span class="p">]</span>

<span class="c"># Make the Pool of workers</span>
<span class="n">pool</span> <span class="o">=</span> <span class="n">ThreadPool</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> 
<span class="c"># Open the urls in their own threads</span>
<span class="c"># and return the results</span>
<span class="n">results</span> <span class="o">=</span> <span class="n">pool</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">urllib2</span><span class="o">.</span><span class="n">urlopen</span><span class="p">,</span> <span class="n">urls</span><span class="p">)</span>
<span class="c">#close the pool and wait for the work to finish </span>
<span class="n">pool</span><span class="o">.</span><span class="n">close</span><span class="p">()</span> 
<span class="n">pool</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
</pre></div>


<p>處理大量圖片的例子。</p>
<div class="highlight"><pre><span class="kn">import</span> <span class="nn">os</span> 
<span class="kn">import</span> <span class="nn">PIL</span>

<span class="kn">from</span> <span class="nn">multiprocessing</span> <span class="kn">import</span> <span class="n">Pool</span> 
<span class="kn">from</span> <span class="nn">PIL</span> <span class="kn">import</span> <span class="n">Image</span>

<span class="n">SIZE</span> <span class="o">=</span> <span class="p">(</span><span class="mi">75</span><span class="p">,</span><span class="mi">75</span><span class="p">)</span>
<span class="n">SAVE_DIRECTORY</span> <span class="o">=</span> <span class="s">&#39;thumbs&#39;</span>

<span class="k">def</span> <span class="nf">get_image_paths</span><span class="p">(</span><span class="n">folder</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span> 
            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">folder</span><span class="p">)</span> 
            <span class="k">if</span> <span class="s">&#39;jpeg&#39;</span> <span class="ow">in</span> <span class="n">f</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">create_thumbnail</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span> 
    <span class="n">im</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
    <span class="n">im</span><span class="o">.</span><span class="n">thumbnail</span><span class="p">(</span><span class="n">SIZE</span><span class="p">,</span> <span class="n">Image</span><span class="o">.</span><span class="n">ANTIALIAS</span><span class="p">)</span>
    <span class="n">base</span><span class="p">,</span> <span class="n">fname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span> 
    <span class="n">save_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">SAVE_DIRECTORY</span><span class="p">,</span> <span class="n">fname</span><span class="p">)</span>
    <span class="n">im</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">save_path</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">folder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span>
        <span class="s">&#39;11_18_2013_R000_IQM_Big_Sur_Mon__e10d1958e7b766c3e840&#39;</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="n">SAVE_DIRECTORY</span><span class="p">))</span>

    <span class="n">images</span> <span class="o">=</span> <span class="n">get_image_paths</span><span class="p">(</span><span class="n">folder</span><span class="p">)</span>

    <span class="n">pool</span> <span class="o">=</span> <span class="n">Pool</span><span class="p">()</span>
    <span class="n">pool</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">create_thumbnail</span><span class="p">,</span><span class="n">images</span><span class="p">)</span>
    <span class="n">pool</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">pool</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
</pre></div>

      </div><!-- /.entry-content -->

    </article>
  </section>
</div>
            </div>
        </div>
    </div>

    <footer id="site-footer">
        <div class="row-fluid">
            <div class="span10 offset1">
                <address>
                    <p>
                        This blog is proudly powered by <a href="http://getpelican.com/">Pelican</a>, which takes great advantage of <a href="http://python.org">Python</a>.
                    </p>
                    <p>
                        <a href="http://github.com/jsliang/pelican-fresh/">Fresh</a> is a responsive theme designed by <a href="http://jsliang.com/">jsliang</a> and <a href="https://github.com/jsliang/pelican-fresh/graphs/contributors">contributors</a>.
                        Special thanks to <a href="http://coding.smashingmagazine.com/2009/08/04/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a> and <a href="http://getbootstrap.com/">Twitter Bootstrap</a>.
                    </p>
                </address>
            </div>
        </div>
    </footer>

    <script src="//code.jquery.com/jquery.min.js"></script>
    <script src="//netdna.bootstrapcdn.com/bootstrap/2.3.2/js/bootstrap.min.js"></script>
</body>
</html>